all: polystorelib polyos

CC=gcc
CFLAGS=-fPIC -shared -D_DEBUG -D_GNU_SOURCE
LIBS=-lpthread -ldl -lrt

UTHASH_DIR := $(abspath ./libs/uthash)
INTERVAL_TREE_DIR := $(abspath ./libs/interval-tree)
SYSCALL_INTERCEPT_SRC_DIR := $(abspath ./libs/syscall-intercept)
SYSCALL_INTERCEPT_DIR := $(SYSCALL_INTERCEPT_SRC_DIR)/build

LDFLAGS=-L$(INTERVAL_TREE_DIR) -lintervaltreelib -L$(SYSCALL_INTERCEPT_DIR) -lsyscall_intercept
INCLUDE=-I$(INTERVAL_TREE_DIR)/ -I$(UTHASH_DIR)/include -I$(SYSCALL_INTERCEPT_SRC_DIR)/include
LIBSRC=$(wildcard ./src/*.c)
BUILD=./build

POLYOS_DIR := $(abspath ./src/polyos)

# Create build directory if not exist
$(shell mkdir -p $(BUILD))

# Flags
POLYSTORE_IOSTAT=-DPOLYSTORE_IO_STAT
POLYSTORE_FILECOPY=-DPOLYSTORE_FILECOPY
POLYSTORE_LARGE_INDEX=-DPOLYSTORE_LARGE_INDEX
POLYSTORE_DYNAMIC=-DPOLYSTORE_DYNAMIC_PLACEMENT
POLYSTORE_CACHE=-DPOLYSTORE_POLYCACHE -DPOLYSTORE_DYNAMIC_PLACEMENT #-DPOLYSTORE_POLYCACHE_DEBUG
POLYSTORE_CACHE_SHM=-DPOLYSTORE_POLYCACHE -DPOLYSTORE_POLYCACHE_SHM -DPOLYSTORE_DYNAMIC_PLACEMENT #-DPOLYSTORE_POLYCACHE_DEBUG

polystorelib:	
	make -C $(INTERVAL_TREE_DIR)
	#cmake -S $(SYSCALL_INTERCEPT_SRC_DIR) -B $(SYSCALL_INTERCEPT_DIR) -DCMAKE_BUILD_TYPE=Release ..
	cmake -B$(SYSCALL_INTERCEPT_DIR) -H$(SYSCALL_INTERCEPT_SRC_DIR) #-DCMAKE_BUILD_TYPE=Release ..
	make -C $(SYSCALL_INTERCEPT_DIR)

	$(CC) $(CFLAGS) $(INCLUDE) -o $(BUILD)/libpolystore.so $(POLYSTORE_BASE) $(LIBSRC) $(LIBS) $(LDFLAGS)
	$(CC) $(CFLAGS) $(INCLUDE) -o $(BUILD)/libpolystore_filecopy.so $(POLYSTORE_FILECOPY) $(POLYSTORE_LARGE_INDEX) $(LIBSRC) $(LIBS) $(LDFLAGS)
	$(CC) $(CFLAGS) $(INCLUDE) -o $(BUILD)/libpolystore_dynamic.so $(POLYSTORE_DYNAMIC) $(LIBSRC) $(LIBS) $(LDFLAGS)
	$(CC) $(CFLAGS) $(INCLUDE) -o $(BUILD)/libpolystore_cache.so $(POLYSTORE_CACHE) $(LIBSRC) $(LIBS) $(LDFLAGS)
	$(CC) $(CFLAGS) $(INCLUDE) -o $(BUILD)/libpolystore_cache_shm.so $(POLYSTORE_CACHE_SHM) $(LIBSRC) $(LIBS) $(LDFLAGS)
	$(CC) $(CFLAGS) $(INCLUDE) -o $(BUILD)/libpolystore_largeindex.so $(POLYSTORE_LARGE_INDEX) $(LIBSRC) $(LIBS) $(LDFLAGS)
	$(CC) $(CFLAGS) $(INCLUDE) -o $(BUILD)/libpolystore_largeindex_cache.so $(POLYSTORE_LARGE_INDEX) $(POLYSTORE_CACHE) $(LIBSRC) $(LIBS) $(LDFLAGS)
	$(CC) $(CFLAGS) $(INCLUDE) -o $(BUILD)/libpolystore_stat.so $(POLYSTORE_BASE) $(POLYSTORE_IOSTAT) $(LIBSRC) $(LIBS) $(LDFLAGS)
	$(CC) $(CFLAGS) $(INCLUDE) -o $(BUILD)/libpolystore_stat_dynamic.so $(POLYSTORE_DYNAMIC) $(POLYSTORE_IOSTAT) $(LIBSRC) $(LIBS) $(LDFLAGS)

polyos:
	make clean -C $(POLYOS_DIR)
	make -C $(POLYOS_DIR)

clean:
	rm -rf $(BUILD)/*.o
	rm -rf $(BUILD)/*.so
	rm -rf $(BUILD)/test_shim
	make clean -C $(POLYOS_DIR)
	make clean -C $(INTERVAL_TREE_DIR)
	make clean -C $(SYSCALL_INTERCEPT_DIR)
	rm -rf $(SYSCALL_INTERCEPT_DIR)/*

